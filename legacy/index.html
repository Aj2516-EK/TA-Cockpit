<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Talent Acquisition Intelligence Cockpit</title>
    <!-- Material Symbols & Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#2196F3",
                        "inst-teal": "#009688",
                        "inst-purple": "#673AB7",
                        "inst-magenta": "#E91E63",
                        "inst-indigo": "#3F51B5",
                        "inst-blue": "#2196F3",
                        surface: "#FFFFFF",
                        "surface-dark": "#1E1E1E",
                        background: "#FAFAFA",
                        "background-dark": "#121212",
                    }
                },
            },
        };

        const config = {
            apiKey: "YOUR_OPENROUTER_API_KEY_HERE",
            model: "openai/gpt-oss-20b:free"
        };

        let rawData = [];
        let filteredData = [];
        let activeCluster = 'readiness';
        let metricsContext = {};
        let globalActions = {};

        const predefinedAnswers = {
            "how much of workforce has transferrable skillset": "Approximately 32% of our **Internal candidates (Employees)** possess core competencies (e.g., project management, crisis handling) that align with lateral engineering and operational management roles. This indicates a high mobility potential within the existing talent ecosystem.",
            "what is the strength of cabin crew talent pool to manage the new demand of 1000 cabin crew next month": "The current Cabin Crew talent pool stands at 8,420 ACTIVE pre-screened candidates. With a historical conversion rate of 12% from 'Qualified State' to 'Offer Accepted', we are positioned to deliver 1,010 hires within the next 30 days, meeting the demand threshold. However, vetting speed remains a critical success factor.",
            "how does time to apply relate with ease of applying metrics": "Correlated analysis shows that every 1-minute reduction in 'Time to Apply' (currently averaging 8.4 mins) results in a +0.2 improvement in the 'Ease of Applying' NPS. The friction point is primarily in the 'Previous Employer' data entry section on mobile devices.",
            "share trend analysis on offer acceptance for last 2 quarters": "Q3 Acceptance Rate: 84.1% / Q4 Acceptance Rate: 86.8%. The +2.7% trend is driven by accelerated 'Time to Offer' (down by 1.4 days) and improved sentiment in the **Internal candidates (Employees)** mobility stream."
        };

        const clusterMetadata = {
            readiness: {
                title: "Talent Readiness & Market Strength",
                description: "Are we ready to hire critical talent right now? Check out the depth, readiness, and speed of supply — the backbone of hiring confidence."
            },
            momentum: {
                title: "Candidate Responsiveness & Momentum",
                description: "How quickly are we responding and moving candidates forward? Check out the momentum loss or gain in the candidate journey."
            },
            experience: {
                title: "Application Experience & Drop-Off Risk",
                description: "Where are candidates getting frustrated or abandoning us? Check out the conversion friction cluster. Small issues here may quietly destroy talent supply!"
            },
            diversity: {
                title: "Diversity & Talent Reach",
                description: "How broad, inclusive, and future-ready is our reach? Check out the reach, inclusivity, and pipeline health at scale."
            },
            economics: {
                title: "Hiring Economics & Efficiency",
                description: "Are we hiring smart and cost-effectively? Check out the supporting efficiency layer, with deep-dive reviews."
            }
        };

        // Deterministic simulation generator
        function getSeed(row, offset = 0) {
            let str = (row?.Employee_ID || "seed") + offset;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash % 1000) / 1000;
        }

        async function initDashboard() {
            setLoading(true, "Synchronizing Neural Engine...");
            try {
                const response = await fetch("Data for Cockpit.xlsx");
                if (!response.ok) throw new Error("File not found");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(worksheet);
                onDataLoaded();
            } catch (e) {
                console.error("Excel Load Error:", e);
                setLoading(false);
                document.getElementById('upload-prompt').classList.remove('hidden');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setLoading(true, "Parsing Dataset...");

            if (file.name.endsWith('.xlsx')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    rawData = XLSX.utils.sheet_to_json(worksheet);
                    document.getElementById('upload-prompt').classList.add('hidden');
                    onDataLoaded();
                };
                reader.readAsArrayBuffer(file);
            } else {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        rawData = results.data;
                        document.getElementById('upload-prompt').classList.add('hidden');
                        onDataLoaded();
                    }
                });
            }
        }

        function onDataLoaded() {
            populateFilters();
            applyFilters();
            setLoading(false);
            const count = rawData.length;
            const displayCount = count >= 1000 ? (count / 1000).toFixed(0) + "k" : count;
            document.getElementById('connection-status').innerText = `Sync Active: ${displayCount} Records`;
        }

        function populateFilters() {
            const cols = ["Department", "Job_Role", "Nationality", "Gender"];
            const container = document.getElementById('filter-options-content');
            if (!container) return;
            container.innerHTML = "";
            const sample = rawData[0] || {};
            const actualKeys = Object.keys(sample);

            cols.forEach(col => {
                const actualKey = actualKeys.find(k => k.toLowerCase().replace(/_/g, ' ') === col.toLowerCase().replace(/_/g, ' ')) ||
                    actualKeys.find(k => k.toLowerCase().includes(col.toLowerCase().replace('_', '').substring(0, 4)));
                if (actualKey) {
                    const uniqueVals = [...new Set(rawData.map(r => r[actualKey]).filter(Boolean))].sort();
                    container.innerHTML += `<div class="mb-4">
                        <h6 class="text-[10px] font-bold text-slate-500 uppercase mb-2">${col.replace('_', ' ')}</h6>
                        <select id="filter-${col.toLowerCase().replace('_', '')}" data-actual-key="${actualKey}" onchange="applyFilters()" class="w-full text-xs rounded-lg border-slate-200 dark:border-slate-700 bg-transparent py-2 focus:ring-primary shadow-sm dark:bg-slate-800 dark:text-white">
                            <option value="">All ${col.replace('_', ' ')}s</option>
                            ${uniqueVals.map(v => `<option value="${v}">${v}</option>`).join('')}
                        </select>
                    </div>`;
                }
            });
        }

        function applyFilters() {
            const filters = Array.from(document.querySelectorAll('[id^="filter-"]'))
                .map(select => ({ key: select.getAttribute('data-actual-key'), val: select.value }))
                .filter(f => f.key && f.val);

            filteredData = rawData.filter(r => {
                for (const f of filters) {
                    if (String(r[f.key]) !== String(f.val)) return false;
                }
                return true;
            });

            calculateMetrics();
            renderActiveCluster();
        }

        function getRAG(val, threshold, type) {
            if (type === 'high') {
                if (val < threshold * 0.8) return 'red';
                if (val < threshold) return 'amber';
                return 'green';
            } else {
                if (val > threshold * 1.5) return 'red';
                if (val > threshold) return 'amber';
                return 'green';
            }
        }

        function calculateMetrics() {
            const count = filteredData.length || 1;
            const s = filteredData[0] || {};

            const selectedJob = document.getElementById('filter-jobrole')?.value || "";
            const selectedDept = document.getElementById('filter-department')?.value || "";
            const targetRef = selectedJob || selectedDept || "Internal candidates (Employees)";
            const targetRefLower = targetRef === "Internal candidates (Employees)" ? "Internal candidates (Employees)" : targetRef.toLowerCase();

            metricsContext = {
                readiness: [
                    { title: "Qualified Candidates Availability", val: (3 + getSeed(s, 1) * 4).toFixed(1), t: 5, typ: 'high', color: "inst-teal", insight: `High potential for niche ${targetRefLower} roles found.`, rec: `Focus sourcing for ${targetRef} on regional voc-centers.`, def: "Measures the volume of pre-screened talent available relative to current demand.", pts: "Candidate Master, Requisition Master", bench: "4.5 per requisition", f: "(Sum of Qualified Candidates) / (Total Requisitions)", i: "groups" },
                    { title: "Talent Pool Skill Readiness (%)", val: (65 + getSeed(s, 2) * 20).toFixed(1) + "%", t: 70, typ: 'high', color: "inst-teal", insight: `${targetRef} skills gap narrowing in current stream.`, rec: `Implement bridge training for the ${targetRef} pool.`, def: "Evaluates the average competency match score of the talent pool for critical roles.", pts: "Skill Assessment Matrix, HR Master", bench: "75%", f: "(Evaluated Skills Score) / (Required Job Skills Baseline)", i: "psychology" },
                    { title: "Active External Connections", val: (800 + Math.floor(getSeed(s, 3) * 600)).toLocaleString(), t: 1000, typ: 'high', color: "inst-teal", insight: `Recruiter network for ${targetRef} growing QoQ.`, rec: `Refresh LinkedIn seats for ${targetRef} specialists.`, def: "Total volume of unique prospective candidates engaged in the last 90 days.", pts: "External Candidate Master, CRM Logs", bench: "1200 leads", f: "Count of Unique External Talent Leads Linked", i: "hub" },
                    { title: "Critical Skill Hiring Capability", val: (85 + getSeed(s, 4) * 10).toFixed(1) + "%", t: 90, typ: 'high', color: "inst-teal", insight: `Good capability in core ${targetRefLower} roles.`, rec: `Upskill HM panels for ${targetRef} calibration.`, def: "Internal team ability to fulfill niche role requirements within specified SLAs.", pts: "Internal Mobility Record, Skill Taxonomy", bench: "92%", f: "(Roles filled with match > 80%) / (Total Critical Role Requests)", i: "military_tech" },
                    { title: "Time to Present Critical Skills (days)", val: (4 + getSeed(s, 5) * 6).toFixed(1), t: 7, typ: 'low', color: "inst-teal", insight: `Lead time for ${targetRefLower} within benchmark.`, rec: `Automate ${targetRefLower} CV screening with AI.`, def: "Days elapsed between requisition opening and identifying the first qualified slate.", pts: "Requisition Master, Candidate Workflow", bench: "5 days", f: "Average (Sourcing Date - Requisition Open Date)", i: "timer" },
                    { title: "Talent Pool Size & Variety", val: "+" + (8 + getSeed(s, 6) * 8).toFixed(1) + "%", t: 10, typ: 'high', color: "inst-teal", insight: `Variety improving for ${targetRefLower} nationals.`, rec: `Launch ${targetRefLower} graduate fair campaign.`, def: "Growth rate of unique talent personas added to the global master pipeline.", pts: "Candidate Master, Demographic Data", bench: "12% growth", f: "(Current Pool Distinct Roles - Previous Period) / (Previous Period)", i: "bar_chart" }
                ],
                momentum: [
                    { title: "Time to Next Step Decision (days)", val: (2 + getSeed(s, 7) * 4).toFixed(1), t: 3, typ: 'low', color: "inst-purple", insight: `Interview delays detected in ${targetRefLower} flow.`, rec: `Set 48hr SLA for ${targetRef} hiring managers.`, def: "Measures process friction between interview completion and hiring manager feedback.", pts: "Interview Logs, Feedback Timestamps", bench: "2 days", f: "Average (Interview Outcome Date - Interview Completion Date)", i: "fact_check" },
                    { title: "Time Spent Matching (hours)", val: (4 + getSeed(s, 8) * 4).toFixed(1), t: 6, typ: 'low', color: "inst-purple", insight: `Manual matching takes time for ${targetRefLower}.`, rec: `Introduce AI auto-matching for ${targetRef}.`, def: "Total labor hours dedicated to mapping candidate skills to job requirements.", pts: "Recruiter Time Tracking, ATS Activity", bench: "4 hours", f: "Total Sourcing Hours / Total Candidates Screened", i: "join_inner" },
                    { title: "Time to CV Response (hours)", val: (18 + getSeed(s, 9) * 12).toFixed(1), t: 24, typ: 'low', color: "inst-purple", insight: `${targetRef} SLA compliance is at 82%.`, rec: `Automate ${targetRefLower} status notifications.`, def: "Latency between a candidate's submission and the recruitment team's initial touchpoint.", pts: "Communication Logs, ATS Timestamps", bench: "12 hours", f: "Average (Notification Sent Date - Application Timestamp)", i: "quickreply" },
                    { title: "Recruiting Experience Rating", val: (4.1 + getSeed(s, 10) * 0.8).toFixed(1), t: 4.2, typ: 'high', color: "inst-purple", insight: `Consistency high in ${targetRefLower} recruitment.`, rec: `Incentivize top rated ${targetRef} recruiters.`, def: "Aggregate satisfaction score from candidate post-application experience surveys.", pts: "Survey Data, Feedback Platform", bench: "4.5", f: "Mean Satisfaction Score from Post-Apply Survey", i: "star" }
                ],
                experience: [
                    { title: "Incomplete Applications (%)", val: (10 + getSeed(s, 11) * 20).toFixed(1) + "%", t: 15, typ: 'low', color: "inst-magenta", insight: `Friction on ${targetRefLower} mobile app detected.`, rec: `Shorten step 2 of ${targetRefLower} application.`, def: "Measures application abandonment rate before final submission.", pts: "Session Logs, Application Status", bench: "8%", f: "(Profiles with Status 'Pending' > 48h) / (Total Initiated Apps)", i: "error_outline" },
                    { title: "Time to Apply (minutes)", val: (8 + getSeed(s, 12) * 6).toFixed(1), t: 10, typ: 'low', color: "inst-magenta", insight: `Application time for ${targetRefLower} is optimal.`, rec: `Maintain current ${targetRefLower} form simplicity.`, def: "Average duration from landing on the JD to final 'Submit' click.", pts: "Session Timestamps", bench: "6 mins", f: "Mean (Submission Timestamp - Start Session Timestamp)", i: "schedule" },
                    { title: "Ease of Applying Rating", val: (4.0 + getSeed(s, 13) * 0.8).toFixed(1), t: 4.0, typ: 'high', color: "inst-magenta", insight: `${targetRef} candidate sentiment is positive.`, rec: `A/B test the ${targetRefLower} upload interface.`, def: "Standardized NPS score gauging the usability of the recruitment portal.", pts: "NPS Survey, UX Feedback", bench: "4.2", f: "Mean NPS Question Score (Ease of Use)", i: "sentiment_satisfied" }
                ],
                diversity: [
                    { title: "Diverse Candidates Attraction (%)", val: (35 + getSeed(s, 14) * 15).toFixed(1) + "%", t: 40, typ: 'high', color: "inst-indigo", insight: `Strong target-group inflow for ${targetRefLower}.`, rec: `Focus on parity for ${targetRef} delivery.`, def: "Inbound volume of candidates belonging to underrepresented demographic groups.", pts: "Applicant Master, Demographic Data", bench: "45%", f: "(Sum of Underrepresented Groups) / (Total Applicant Pool)", i: "favorite" },
                    { title: "Diverse Talent Pipeline (%)", val: (32 + getSeed(s, 15) * 15).toFixed(1) + "%", t: 40, typ: 'high', color: "inst-indigo", insight: `${targetRef} pipeline conversion slightly low.`, rec: `Diversify ${targetRefLower} interview panels.`, def: "Survival rate of diverse candidates from the screening phase to final offer.", pts: "Workflow Master, Diversity Tracking", bench: "40%", f: "(Diverse Candidates at Offer Stage) / (Diverse Candidates at Screen)", i: "timeline" },
                    { title: "Active Applicants", val: (5000 + Math.floor(getSeed(s, 16) * 10000)).toLocaleString(), t: 8000, typ: 'high', color: "inst-indigo", insight: `High demand signal for ${targetRefLower} roles.`, rec: `Scale regional ${targetRefLower} campaigns.`, def: "Total volume of candidates currently positioned in 'Under Review' or 'Interview' stages.", pts: "Applicant Master, Workflow Logs", bench: "12000 users", f: "Count of Live Applications (Status != Closed)", i: "person_search" }
                ],
                economics: [
                    { title: "Cost per Acquisition", val: "$" + (2000 + Math.floor(getSeed(s, 17) * 2000)).toLocaleString(), t: 2500, typ: 'low', color: "inst-blue", insight: `${targetRef} cost efficiency within budget.`, rec: `Shift budget to local ${targetRefLower} sourcing.`, def: "Total capital investment required to successfully convert an external lead to a hire.", pts: "Finance Master, Marketing Spend, Offers", bench: "$1800", f: "(Total Sourcing + Marketing Spend) / (Total Hires)", i: "account_balance_wallet" },
                    { title: "Candidates Presented vs Offers Made (%)", val: (20 + getSeed(s, 18) * 20).toFixed(1) + "%", t: 25, typ: 'high', color: "inst-blue", insight: `Volume suggests loose ${targetRefLower} criteria.`, rec: `Tighten ${targetRefLower} auto-filter screening.`, def: "Efficiency of the shortlisting quality—ratio of presented slates resulting in offers.", pts: "Requisition Master, Offer Master", bench: "30%", f: "(Count of Offers) / (Count of Shortlisted Profiles Presented)", i: "check_circle" },
                    { title: "Job Posting Effectiveness", val: (6 + getSeed(s, 19) * 6).toFixed(1) + "%", t: 8, typ: 'high', color: "inst-blue", insight: `Source ROI higher for ${targetRefLower}.`, rec: `Reallocate budget for top ${targetRef} sources.`, def: "Conversion efficacy of paid job platforms relative to spend.", pts: "Marketing Distribution, ATS Sources", bench: "10%", f: "(Hires per Source) / (Total Spend per Source)", i: "campaign" },
                    { title: "Hires from Competitors (%)", val: (12 + getSeed(s, 20) * 10).toFixed(1) + "%", t: 15, typ: 'high', color: "inst-blue", insight: `Market pull for ${targetRefLower} is high.`, rec: `Conduct exit-interviews for ${targetRef} staff.`, def: "Market capture rate of experienced talent from industry peer organizations.", pts: "Applicant Master, Employment History", bench: "18%", f: "(Hires with Competitor Experience) / (Total Hires)", i: "transfer_within_a_station" },
                    { title: "Hiring Manager Feedback Time (days)", val: (1.5 + getSeed(s, 21) * 2).toFixed(1), t: 2, typ: 'low', color: "inst-blue", insight: `Delays in ${targetRefLower} feedback loops.`, rec: `Escalate ${targetRefLower} feedback to EVP.`, def: "Average latency of departmental decision-makers in qualifying candidate slates.", pts: "Feedback Logs, Requisition Activity", bench: "2 days", f: "Average (Hiring Manager Screen Feedback Date - CV Submission Date)", i: "comment" },
                    { title: "JD Criteria Match (%)", val: (70 + getSeed(s, 22) * 20).toFixed(1) + "%", t: 75, typ: 'high', color: "inst-blue", insight: `Good fit criteria for ${targetRefLower} roles.`, rec: `Refine technical ${targetRef} JD precision.`, def: "Automated match alignment score between applicant profile and job description requirements.", pts: "Candidate Profile, JD Semantic Analysis", bench: "80%", f: "Average (Candidate Match Score) across Filtered Set", i: "rule" },
                    { title: "Interviewed vs Offered Ratio", val: "1:" + (3 + getSeed(s, 23) * 2).toFixed(1), t: 0.25, typ: 'high', color: "inst-blue", insight: `Yield is healthy for ${targetRefLower} roles.`, rec: `Improve ${targetRefLower} panel training.`, def: "Selectivity and conversion efficiency of the interview process.", pts: "Interview Master, Offer Data", bench: "1:4", f: "(Total Interviews Attended) / (Total Offers Issued)", i: "assignment_ind" }
                ]
            };

            // Process RAG & Calculate Cluster Scores
            const clusterScores = [];
            Object.keys(metricsContext).forEach(k => {
                let totalClusterScore = 0;
                metricsContext[k].forEach(m => {
                    const numericVal = parseFloat(String(m.val).replace(/[^0-9.]/g, '')) || 0;
                    m.rag = getRAG(numericVal, m.t, m.typ);
                    m.sortOrder = m.rag === 'red' ? 1 : (m.rag === 'amber' ? 2 : 3);

                    // Score mapping: Green=100, Amber=70, Red=40
                    totalClusterScore += (m.rag === 'green' ? 100 : (m.rag === 'amber' ? 70 : 40));
                });
                metricsContext[k].sort((a, b) => a.sortOrder - b.sortOrder);
                clusterScores.push(totalClusterScore / metricsContext[k].length);
            });

            const finalHealthScore = (clusterScores.reduce((a, b) => a + b, 0) / clusterScores.length).toFixed(1);
            document.getElementById('global-score').innerText = finalHealthScore;

            // Health Donut RAG Coloring
            const score = parseFloat(finalHealthScore);
            const circle = document.getElementById('health-donut-circle');
            if (circle) {
                let color = "#10B981"; // Green
                if (score <= 50) color = "#EF4444"; // Red
                else if (score <= 80) color = "#F59E0B"; // Amber
                circle.setAttribute('stroke', color);
            }
        }

        function renderActiveCluster() {
            const container = document.getElementById('metric-grid');
            container.innerHTML = "";
            const metrics = metricsContext[activeCluster] || [];

            metrics.forEach(m => {
                const bgColor = m.rag === 'red' ? 'bg-red-500/95' : (m.rag === 'amber' ? 'bg-amber-500/95' : 'bg-emerald-500/95');
                const actionKey = activeCluster + '_' + m.title.replace(/\s+/g, '_');
                const action = globalActions[actionKey];

                let actionHTML = `<button class="w-full py-2 bg-white/25 hover:bg-white/40 text-white text-[10px] font-bold uppercase rounded-xl transition-colors" onclick="showAssignUI(this, '${actionKey}')">Assign Action</button>`;
                if (action) {
                    actionHTML = `
                    <div class="p-3 bg-black/20 rounded-xl text-[10px] text-white">
                        <div class="flex items-center gap-1 mb-1 font-black uppercase text-[8px] opacity-70"><span class="material-symbols-rounded text-xs">task_alt</span> Assigned</div>
                        <p class="font-bold">To: ${action.user}</p>
                        <p class="mt-1 italic opacity-90">"${action.comment}"</p>
                        <p class="mt-2 text-[8px] opacity-60">${action.date}</p>
                    </div>`;
                }

                container.innerHTML += `
                <div class="${bgColor} text-white p-6 rounded-3xl shadow-xl flex flex-col justify-between" id="card-${actionKey}">
                    <div>
                         <div class="flex justify-between items-start mb-4">
                            <span class="p-1 rounded-md bg-white/10 flex items-center justify-center">
                                <span class="material-symbols-rounded text-white/80 text-xl">${m.i || 'analytics'}</span>
                            </span>
                            <div class="flex gap-2">
                                <button onclick="showFormulaOverlay('${m.title}', '${m.def}', '${m.pts}', '${m.bench}', '${m.f}')" class="hover:bg-white/20 p-1 rounded-full transition-all active:scale-90"><span class="material-symbols-rounded text-white/60 text-lg">info</span></button>
                                <span class="material-symbols-rounded text-white/40 text-xl">analytics</span>
                            </div>
                        </div>
                        <h5 class="text-xs font-black uppercase tracking-wider mb-2 leading-tight opacity-90">${m.title}</h5>
                        <div class="text-4xl font-light mb-4 tracking-tighter">${m.val}</div>
                        <div class="space-y-3 mb-6">
                            <div class="p-3 bg-white/10 rounded-xl border border-white/10 hover:bg-white/15 transition-all">
                                <span class="text-[9px] font-black uppercase tracking-widest block mb-1 opacity-70">AI Insight</span>
                                <p class="text-[12px] leading-relaxed font-bold">${m.insight}</p>
                            </div>
                            <div class="p-3 bg-white/10 rounded-xl border border-white/10 hover:bg-white/15 transition-all">
                                <span class="text-[9px] font-black uppercase tracking-widest block mb-1 opacity-70">AI Recommendation</span>
                                <p class="text-[12px] leading-relaxed font-bold">${m.rec}</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-[9px] font-black uppercase opacity-60 mb-4 border-t border-white/10 pt-4 flex justify-between items-center text-[10px]">
                             <span>Threshold</span>
                             <span>${m.typ === 'high' ? '>' : '<'} ${m.t}</span>
                        </div>
                        <div class="action-slot">${actionHTML}</div>
                    </div>
                </div>`;
            });
        }

        function showAssignUI(btn, key) {
            const slot = btn.parentElement;
            slot.innerHTML = `
            <div class="space-y-2 p-3 bg-black/20 rounded-xl">
                <select id="user-${key}" class="w-full text-[10px] bg-white/10 border-white/20 rounded-lg text-white font-bold py-1 focus:ring-primary h-8">
                    <option class="text-black" value="John">John</option>
                    <option class="text-black" value="Jerry">Jerry</option>
                    <option class="text-black" value="Jack">Jack</option>
                    <option class="text-black" value="Jina">Jina</option>
                    <option class="text-black" value="Jisha">Jisha</option>
                    <option class="text-black" value="Jamal">Jamal</option>
                </select>
                <input type="text" id="comment-${key}" placeholder="Instructions..." class="w-full text-[10px] bg-white/10 border-white/20 rounded-lg text-white placeholder-white/40 py-1 h-8 px-2">
                <div class="flex flex-col gap-1">
                    <label class="text-[8px] font-black uppercase opacity-50 text-white">Target Completion Date</label>
                    <input type="date" id="date-${key}" class="w-full text-[10px] bg-white/10 border-white/20 rounded-lg text-white py-1 h-8 px-2">
                </div>
                <div class="flex gap-2">
                    <button class="flex-1 py-1 bg-white text-black font-bold text-[9px] rounded-lg" onclick="saveAction('${key}')">Confirm</button>
                    <button class="flex-1 py-1 bg-white/10 text-white font-bold text-[9px] rounded-lg" onclick="renderActiveCluster()">X</button>
                </div>
            </div>`;
        }

        function saveAction(key) {
            const user = document.getElementById('user-' + key).value;
            const comment = document.getElementById('comment-' + key).value || "No comment provided";
            const targetDate = document.getElementById('date-' + key).value;
            const creationDate = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            globalActions[key] = { user, comment, date: creationDate, targetDate };

            // Trigger Email Notification
            const clusterTitle = clusterMetadata[activeCluster].title;
            const metric = metricsContext[activeCluster].find(m => (activeCluster + '_' + m.title.replace(/\s+/g, '_')) === key);

            const subject = encodeURIComponent(`TA Action Assigned: ${metric.title}`);
            const body = encodeURIComponent(`Hello ${user},\n\nYou have been assigned a strategic action in the TA Intelligence Cockpit.\n\n` +
                `--- ACTION DETAILS ---\n` +
                `Metric: ${metric.title}\n` +
                `Cluster: ${clusterTitle}\n` +
                `Current Value: ${metric.val}\n` +
                `Assignment: ${comment}\n` +
                `Target Completion: ${targetDate || 'TBD'}\n` +
                `Assigned On: ${creationDate}\n\n` +
                `Please log into the Cockpit to update the status.\n\nGenerated by TA-Intelligence-Hub`);

            window.location.href = `mailto:${user}@emirates.com?subject=${subject}&body=${body}`;

            localStorage.setItem('ta_actions', JSON.stringify(globalActions));
            renderActiveCluster();
        }

        function showFormulaOverlay(title, def, pts, bench, formula) {
            const overlay = document.getElementById('formula-overlay');
            overlay.innerHTML = `
                <div class="bg-slate-900/95 text-white p-10 rounded-[48px] shadow-[0_32px_64px_rgba(0,0,0,0.5)] border border-white/10 max-w-xl w-full transform transition-all animate-in fade-in zoom-in slide-in-from-bottom-8 duration-500 backdrop-blur-3xl relative overflow-hidden" onclick="event.stopPropagation()">
                    <div class="absolute -top-24 -right-24 w-64 h-64 bg-primary/10 rounded-full blur-3xl"></div>
                    <div class="flex items-center gap-4 mb-8 text-primary">
                        <span class="material-symbols-rounded text-4xl">inventory_2</span>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-black uppercase tracking-[0.3em] opacity-50">Metric Consult</span>
                            <span class="text-xl font-bold tracking-tight">${title}</span>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div>
                            <p class="text-sm font-medium leading-relaxed opacity-90 italic">"${def}"</p>
                        </div>
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <span class="text-[9px] font-black uppercase tracking-widest text-primary block mb-2">Data Source</span>
                                <p class="text-xs font-bold opacity-80">${pts}</p>
                            </div>
                            <div>
                                <span class="text-[9px] font-black uppercase tracking-widest text-primary block mb-2">Strategic Benchmark</span>
                                <p class="text-xs font-bold opacity-80">${bench}</p>
                            </div>
                        </div>
                        <div class="p-6 bg-white/5 rounded-3xl border border-white/5 shadow-inner">
                            <span class="text-[9px] font-black uppercase tracking-widest text-primary block mb-3 text-center">Formula Used</span>
                            <p class="text-[15px] font-mono font-bold text-center text-primary tracking-tighter">${formula}</p>
                        </div>
                    </div>
                    <div class="mt-10 pt-6 border-t border-white/5 text-[9px] font-black uppercase tracking-[0.4em] opacity-30 text-center animate-pulse">Tap outside to dismiss Cockpit Consult</div>
                </div>
            `;
            overlay.classList.remove('hidden');
        }

        function showHealthFormula() {
            showFormulaOverlay(
                'Health Score Logic',
                'This score represents our overall hiring performance across all departments. It summarizes readiness, speed, candidate experience, diversity, and cost into one single benchmark.',
                'Active Dataset (All Streams)',
                '100.0 (Perfect Operations)',
                '(Metrics on Track * 100 + Metrics with Minor Issues * 70 + Critical Metrics * 40) / Total Number of KPIs'
            );
        }

        function checkDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            Object.keys(globalActions).forEach(key => {
                const action = globalActions[key];
                if (action.targetDate === today) {
                    alert(`Action Deadline Reached: ${action.comment} (Assigned to ${action.user})`);
                }
            });
        }

        async function askAI() {
            const queryInput = document.getElementById('ai-input');
            const query = queryInput.value.trim();
            if (!query) return;

            // UI Feedback
            const overlay = document.getElementById('ai-overlay');
            const queryDisplay = document.getElementById('ai-query');
            const loader = document.getElementById('ai-loading');
            const resultBox = document.getElementById('ai-result');
            const textContent = document.getElementById('ai-text');

            overlay.classList.remove('hidden');
            queryDisplay.innerText = query;
            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');

            // Check for readymade answers
            const cleanQuery = query.toLowerCase().replace(/[?.,']/g, "").trim();
            for (const [key, val] of Object.entries(predefinedAnswers)) {
                const cleanKey = key.toLowerCase().replace(/[?.,']/g, "").trim();
                if (cleanQuery.includes(cleanKey) || cleanKey.includes(cleanQuery)) {
                    await new Promise(r => setTimeout(r, 800)); // Simulated thought
                    textContent.innerHTML = `<div class="p-4 bg-primary/5 border-l-4 border-primary rounded-xl mb-6 shadow-sm"><span class="text-[10px] font-black uppercase text-primary tracking-widest block mb-2 opacity-70">Neural Precision Match Found</span><p class="text-sm leading-relaxed">${val}</p></div>`;
                    loader.classList.add('hidden');
                    resultBox.classList.remove('hidden');
                    return;
                }
            }

            // Data Contextualization
            const sampleSize = Math.min(filteredData.length, 2000);
            const dataSummary = {
                total_in_filter: filteredData.length,
                dept_breakdown: {},
                gender_ratio: { Male: 0, Female: 0 }
            };

            filteredData.slice(0, sampleSize).forEach(r => {
                dataSummary.dept_breakdown[r.Department] = (dataSummary.dept_breakdown[r.Department] || 0) + 1;
                dataSummary.gender_ratio[r.Gender]++;
            });

            const activeMetrics = metricsContext[activeCluster];
            const isTrendQuery = /trend|month|quarter|history|future|forecast|period|time/i.test(query);

            const systemPrompt = `You are a Senior Strategic TA Analyst.
            Dataset Context: ${filteredData.length} records including Job Requisitions, Offers, and Applicant Masters.
            Current Cluster focus: ${activeCluster}.
            Live Data Point Breakdown: ${JSON.stringify(dataSummary)}
            
            Strict Rule: DO NOT BE GENERIC. Use the numbers provided. 
            Relate your answer to the Airline Industry context (Crew, Pilots, Engineering, Corporate).
            For Trend/History: Snapshot shows high-vol volatility. Predict the cascade effect on 'Offer Acceptance' and 'Hiring Momentum' based on the RAG status of current metrics.
            If red, identify specific friction points in ${activeCluster}. Use 'Internal candidates (Employees)' term.`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${config.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": "https://ta-dashboard.cockpit",
                        "X-Title": "TA Intelligence Hub"
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Query: ${query}` }
                        ]
                    })
                });

                const data = await response.json();

                if (data.choices && data.choices[0]) {
                    textContent.innerText = data.choices[0].message.content;
                } else {
                    textContent.innerText = "Neural Hub is currently optimizing. Please retry your consult in a few moments.";
                }

                loader.classList.add('hidden');
                resultBox.classList.remove('hidden');
            } catch (e) {
                console.error("AI Fetch Failure:", e);
                textContent.innerText = "Connection Refused: TA Neural Core is offline. Check API connectivity.";
                loader.classList.add('hidden');
                resultBox.classList.remove('hidden');
            }
        }

        function resetFilters() {
            document.querySelectorAll('[id^="filter-"]').forEach(s => s.value = "");
            applyFilters();
            document.getElementById('filter-panel').classList.add('hidden');
        }

        function switchCluster(id) {
            activeCluster = id;
            document.querySelectorAll('.sunburst-seg').forEach(btn => btn.classList.remove('active'));
            const seg = document.getElementById('seg-' + id);
            if (seg) seg.classList.add('active');
            renderActiveCluster();

            const meta = clusterMetadata[id];
            if (meta) {
                document.getElementById('cluster-title-display').innerText = meta.title;
                document.getElementById('cluster-description-display').innerText = meta.description;
            }
        }

        function setLoading(l, t = "") {
            document.getElementById('global-loader').classList.toggle('hidden', !l);
            document.getElementById('loader-text').innerText = t;
        }

        window.onload = () => {
            initDashboard();
            checkDeadlines();

            // Close filter panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('filter-panel');
                const btn = document.getElementById('filter-toggle-btn');
                if (panel && btn && !panel.contains(e.target) && !btn.contains(e.target) && !panel.classList.contains('hidden')) {
                    panel.classList.add('hidden');
                }
            });
        };
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body { @apply font-sans bg-background dark:bg-background-dark text-slate-900 dark:text-slate-200 min-h-screen overflow-hidden; }
        }
        .sunburst-seg { @apply flex flex-col items-center justify-center p-4 bg-surface dark:bg-surface-dark border border-slate-200 dark:border-white/5 cursor-pointer transition-all hover:bg-primary/5 active:scale-95 shadow-lg min-h-[120px] rounded-3xl; }
        .sunburst-seg.active { @apply bg-primary text-white border-primary shadow-2xl scale-105; }
        .sunburst-seg.active .material-symbols-rounded { @apply text-white; }
        .sunburst-seg.active span { @apply text-white font-bold; }
        .sunburst-seg .material-symbols-rounded { @apply text-4xl mb-2; }
        .sunburst-seg span { @apply text-[10px] font-black uppercase tracking-[0.1em] text-center; }
        
        #seg-readiness, #seg-momentum, #seg-experience { @apply rounded-l-3xl rounded-r-none translate-x-4; }
        #seg-diversity, #seg-economics { @apply rounded-r-3xl rounded-l-none -translate-x-4; }
    </style>
</head>

<body class="flex flex-col h-screen">
    <header
        class="h-16 bg-surface dark:bg-surface-dark shadow-material-1 flex items-center justify-between px-8 relative z-50">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-primary/10 rounded-xl"><span
                    class="material-symbols-rounded text-primary text-2xl">flight_takeoff</span></div>
            <span id="connection-status"
                class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Connecting...</span>
        </div>

        <h1
            class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-xl font-black uppercase tracking-widest lg:block hidden">
            Talent Acquisition Intelligence Cockpit</h1>

        <div class="flex items-center gap-4">
            <button id="filter-toggle-btn" onclick="document.getElementById('filter-panel').classList.toggle('hidden')"
                class="w-12 h-12 rounded-2xl flex items-center justify-center bg-primary/5 dark:bg-primary/20 hover:bg-primary hover:text-white text-primary transition-all shadow-button">
                <span class="material-symbols-rounded">filter_list</span>
            </button>
            <button onclick="document.documentElement.classList.toggle('dark')"
                class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/5 text-slate-500">
                <span class="material-symbols-rounded dark:hidden">dark_mode</span>
                <span class="material-symbols-rounded hidden dark:block text-amber-400">light_mode</span>
            </button>
            <div
                class="flex items-center gap-2 pl-4 border-l border-slate-200 dark:border-white/10 group cursor-pointer">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-black uppercase tracking-widest leading-none">EVP-HR</p>
                </div>
                <div
                    class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-all shadow-lg">
                    <span class="material-symbols-rounded text-2xl">account_circle</span>
                </div>
            </div>
        </div>
    </header>

    <div id="filter-panel"
        class="hidden fixed top-20 right-8 w-80 bg-surface dark:bg-surface-dark shadow-[0_20px_50px_rgba(0,0,0,0.3)] rounded-[32px] p-8 z-[1000] border border-slate-200 dark:border-white/10 backdrop-blur-3xl">
        <div class="flex justify-between items-center mb-6">
            <h6 class="text-sm font-black uppercase text-primary tracking-widest">Dataset Filters</h6>
            <button onclick="document.getElementById('filter-panel').classList.add('hidden')"
                class="text-slate-400 hover:text-primary transition-colors"><span
                    class="material-symbols-rounded">close</span></button>
        </div>
        <div id="filter-options-content" class="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"></div>
        <div class="mt-8 pt-4 border-t border-slate-100 dark:border-white/5">
            <button onclick="resetFilters()"
                class="w-full py-3 bg-slate-100 dark:bg-white/5 text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-primary/10 hover:text-primary transition-all">Clear
                All Filters</button>
        </div>
    </div>
    <main class="flex-grow flex flex-col p-8 gap-8 overflow-hidden">
        <!-- Horizontal Command Strip: Donut + 5 Clusters -->
        <section class="flex items-center gap-4 flex-none overflow-x-auto pb-4 no-scrollbar">

            <!-- Health Score: Executive Summary Tile -->
            <div
                class="flex-none p-5 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 rounded-[40px] shadow-2xl border border-slate-200 dark:border-white/5 flex items-center gap-8 pr-12 relative group ring-1 ring-black/5 dark:ring-white/5">
                <div class="relative w-32 h-32 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90 absolute scale-110" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#E2E8F0" stroke-width="6"
                            class="dark:stroke-slate-700/50"></circle>
                        <circle id="health-donut-circle" cx="50" cy="50" r="45" fill="none" stroke="#2196F3"
                            stroke-width="12" stroke-dasharray="240 283" stroke-linecap="round"
                            class="transition-all duration-1000 drop-shadow-[0_0_8px_rgba(33,150,243,0.3)]"></circle>
                    </svg>
                    <div class="flex flex-col items-center z-10">
                        <div class="text-3xl font-black text-slate-800 dark:text-white" id="global-score">88.4</div>
                    </div>
                </div>
                <div class="max-w-[160px]">
                    <div class="flex items-center gap-2 mb-2">
                        <span
                            class="text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-[0.2em]">Health
                            Score</span>
                        <button onclick="showHealthFormula()"
                            class="bg-primary/10 hover:bg-primary/20 text-primary p-1 rounded-lg transition-all active:scale-90">
                            <span class="material-symbols-rounded text-sm">info</span>
                        </button>
                    </div>
                    <p class="text-[11px] font-bold leading-tight text-slate-400 dark:text-slate-500">Real-time Sourcing
                        & Pipeline Vitality</p>
                </div>
            </div>
            <!-- 5 Sequential Clusters -->
            <div class="flex-grow flex gap-4">
                <div class="sunburst-seg active flex-1" id="seg-readiness" onclick="switchCluster('readiness')">
                    <span class="material-symbols-rounded text-inst-teal">rocket_launch</span>
                    <span>Readiness</span>
                </div>
                <div class="sunburst-seg flex-1" id="seg-momentum" onclick="switchCluster('momentum')">
                    <span class="material-symbols-rounded text-inst-purple">bolt</span>
                    <span>Momentum</span>
                </div>
                <div class="sunburst-seg flex-1" id="seg-experience" onclick="switchCluster('experience')">
                    <span class="material-symbols-rounded text-inst-magenta">sentiment_satisfied</span>
                    <span>Experience</span>
                </div>
                <div class="sunburst-seg flex-1" id="seg-diversity" onclick="switchCluster('diversity')">
                    <span class="material-symbols-rounded text-inst-indigo">diversity_3</span>
                    <span>Diversity</span>
                </div>
                <div class="sunburst-seg flex-1" id="seg-economics" onclick="switchCluster('economics')">
                    <span class="material-symbols-rounded text-inst-blue">payments</span>
                    <span>Economics</span>
                </div>
            </div>
        </section>

        <!-- Metric RAG Grid -->
        <section
            class="flex-grow flex flex-col bg-slate-50 dark:bg-zinc-950 rounded-[40px] shadow-2xl min-h-0 border border-black/5 overflow-hidden">
            <div class="px-10 py-6 border-b border-black/5 dark:border-white/5 bg-white dark:bg-black/20">
                <div class="flex items-center justify-between gap-8">
                    <h3
                        class="text-2xl font-black uppercase tracking-widest text-slate-800 dark:text-white flex items-center gap-4">
                        <span id="cluster-title-display">Talent Readiness & Market Strength</span>
                        <span id="upload-prompt" class="hidden"><input type="file" onchange="handleFileUpload(event)"
                                class="text-[10px] file:bg-primary/10 file:border-none file:rounded-xl"></span>
                    </h3>

                    <!-- Ask AI Hub: Highlighted on Cluster Row -->
                    <div class="relative w-[480px] group">
                        <div
                            class="absolute -inset-1 bg-gradient-to-r from-primary/10 to-primary/30 blur-lg rounded-full opacity-50 group-hover:opacity-100 transition-opacity">
                        </div>
                        <div
                            class="relative flex items-center bg-white dark:bg-slate-900 border-2 border-primary/20 dark:border-primary/40 rounded-full px-5 py-2.5 shadow-xl hover:shadow-primary/20 transition-all">
                            <span
                                class="material-symbols-rounded text-primary text-xl animate-pulse mr-3">auto_awesome</span>
                            <input type="text" id="ai-input"
                                placeholder="Ask AI: Trends, Predictive Analysis, Metrics..."
                                class="bg-transparent border-none outline-none text-xs font-bold w-full placeholder-slate-400 dark:text-white"
                                onkeypress="if(event.key==='Enter') askAI()">
                            <button onclick="askAI()"
                                class="ml-3 p-1.5 bg-primary rounded-full text-white hover:scale-110 transition-all shadow-lg active:scale-95">
                                <span class="material-symbols-rounded text-sm">send</span>
                            </button>
                        </div>
                    </div>
                </div>
                <p id="cluster-description-display"
                    class="text-[16px] font-bold text-slate-500 dark:text-slate-400 mt-2 max-w-4xl leading-relaxed">Are
                    we ready to hire
                    critical talent right now? Check out the depth, readiness, and speed of supply — the backbone of
                    hiring confidence.</p>
            </div>
            <div class="flex-grow overflow-y-auto p-10">
                <div id="metric-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"></div>
            </div>
        </section>
    </main>

    <div id="global-loader"
        class="hidden fixed inset-0 z-[100] bg-white/80 dark:bg-black/90 backdrop-blur-md flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-xs font-black uppercase tracking-widest text-slate-400"></p>
    </div>

    <div id="ai-overlay"
        class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
        <div
            class="bg-surface dark:bg-surface-dark rounded-[40px] shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden relative">
            <button onclick="document.getElementById('ai-overlay').classList.add('hidden')"
                class="absolute top-10 right-10 text-slate-400"><span
                    class="material-symbols-rounded">close</span></button>
            <div class="p-10 border-b border-slate-100 dark:border-white/5 bg-primary/5">
                <div class="flex items-center gap-3 mb-2 text-primary font-black uppercase tracking-widest"><span
                        class="material-symbols-rounded">auto_awesome</span><span>AI Advisor</span></div>
                <p id="ai-query" class="text-sm font-mono text-slate-500 italic"></p>
            </div>
            <div class="p-10 overflow-y-auto">
                <div id="ai-loading" class="flex flex-col items-center py-10">
                    <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4">
                    </div>
                    <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-slate-400">Processing Metric
                        Stream...</p>
                </div>
                <div id="ai-result" class="hidden text-sm leading-relaxed text-slate-700 dark:text-slate-300">
                    <p id="ai-text"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formula Overlay -->
    <div id="formula-overlay" onclick="this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[600] bg-black/60 backdrop-blur-md flex items-center justify-center p-6">
    </div>
</body>

</html>